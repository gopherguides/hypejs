'use strict';

var uuid = require('uuid');

let gotypes = {
    Body: "*hype.Body",
    Cmd: "*hype.Cmd",
    CmdResult: "*hype.CmdResult",
    Element: "*hype.Element",
    FencedCode: "*hype.FencedCode",
    Figcaption: "*hype.Figcaption",
    Figure: "*hype.Figure",
    Heading: "hype.Heading",
    Image: "*hype.Image",
    Include: "*hype.Include",
    InlineCode: "*hype.InlineCode",
    LI: "*hype.LI",
    Link: "*hype.Link",
    OL: "*hype.OL",
    Page: "*hype.Page",
    Paragraph: "*hype.Paragraph",
    Ref: "*hype.Ref",
    Snippet: "hype.Snippet",
    SourceCode: "*hype.SourceCode",
    TD: "*hype.TD",
    TH: "*hype.TH",
    THead: "*hype.THead",
    TR: "*hype.TR",
    Table: "*hype.Table",
    Text: "hype.Text",
    UL: "*hype.UL",
};

class Element {
    constructor(el) {
        this.attributes = {};
        this.atom = el.atom;
        this.type = el.type;
        this.file = el.file;
        this.nodes = el.nodes ? el.nodes : [];
        this.attributes = el.attributes ? el.attributes : {};
        if (this.attributes === undefined) {
            this.attributes = {};
        }
    }
    toString() {
        var _a;
        let s = "";
        (_a = this.nodes) === null || _a === void 0 ? void 0 : _a.forEach((n) => {
            if (n === undefined)
                return;
            s += n.toString();
        });
        if (this.atom === undefined)
            return s;
        let tag = `<${this.atom}`;
        let ats = this.attributes ? this.attributes : {};
        for (let [key, value] of Object.entries(ats)) {
            tag += ` ${key}="${value}"`;
        }
        tag += `>${s}</${this.atom}>`;
        return tag;
    }
    toHtml() {
        return this.toString() + "\n";
    }
}
function NewElement(atom, attrs) {
    return new Element({
        atom: atom,
        nodes: [],
        type: gotypes.Element,
        attributes: attrs,
    });
}

class Cmd extends Element {
    constructor(c) {
        super(c);
        this.expected_exit = c.expected_exit;
        this.args = c.args ? c.args : [];
        this.timeout = c.timeout ? c.timeout : "30s";
    }
}

class CmdResult extends Element {
    constructor(cr) {
        super(cr);
        this.result = cr.result;
    }
}

class FencedCode extends Element {
    constructor(fc) {
        super(fc);
        this.lang = fc.lang;
    }
}

class FigCaption extends Element {
    constructor(fc) {
        super(fc);
    }
}

class Figure extends Element {
    constructor(f) {
        super(f);
        if (f.style === "") {
            f.style = "listing";
        }
        if (f.pos < 1) {
            f.pos = 1;
        }
        f.section_id ? f.section_id : 1;
        this.pos = f.pos;
        this.style = f.style;
        this.section_id = f.section_id;
    }
}

class Heading extends Element {
    constructor(n) {
        super(n);
        this.level = 1;
        this.text = n.text;
        this.level = n.level;
        if (this.level < 1)
            this.level = 1;
    }
}

class Image extends Element {
    constructor(img) {
        super(img);
    }
}

class Include extends Element {
    constructor(el) {
        super(el);
        this.dir = el.dir;
    }
}

class InlineCode extends Element {
    constructor(t) {
        super(t);
    }
}

class LI extends Element {
    constructor(li) {
        super(li);
    }
}

// Code generated by gen.go. DO NOT EDIT.
let atoms = {
    A: "a",
    Abbr: "abbr",
    Accept: "accept",
    AcceptCharset: "accept-charset",
    Accesskey: "accesskey",
    Acronym: "acronym",
    Action: "action",
    Address: "address",
    Align: "align",
    Allowfullscreen: "allowfullscreen",
    Allowpaymentrequest: "allowpaymentrequest",
    Allowusermedia: "allowusermedia",
    Alt: "alt",
    Annotation: "annotation",
    AnnotationXml: "annotation-xml",
    Applet: "applet",
    Area: "area",
    Article: "article",
    As: "as",
    Aside: "aside",
    Async: "async",
    Audio: "audio",
    Autocomplete: "autocomplete",
    Autofocus: "autofocus",
    Autoplay: "autoplay",
    B: "b",
    Base: "base",
    Basefont: "basefont",
    Bdi: "bdi",
    Bdo: "bdo",
    Bgsound: "bgsound",
    Big: "big",
    Blink: "blink",
    Blockquote: "blockquote",
    Body: "body",
    Br: "br",
    Button: "button",
    Canvas: "canvas",
    Caption: "caption",
    Center: "center",
    Challenge: "challenge",
    Charset: "charset",
    Checked: "checked",
    Cite: "cite",
    Class: "class",
    Cmd: "cmd",
    Code: "code",
    Col: "col",
    Colgroup: "colgroup",
    Color: "color",
    Cols: "cols",
    Colspan: "colspan",
    Command: "command",
    Content: "content",
    Contenteditable: "contenteditable",
    Contextmenu: "contextmenu",
    Controls: "controls",
    Coords: "coords",
    Crossorigin: "crossorigin",
    Data: "data",
    Datalist: "datalist",
    Datetime: "datetime",
    Dd: "dd",
    Default: "default",
    Defer: "defer",
    Del: "del",
    Desc: "desc",
    Details: "details",
    Dfn: "dfn",
    Dialog: "dialog",
    Dir: "dir",
    Dirname: "dirname",
    Disabled: "disabled",
    Div: "div",
    Dl: "dl",
    Download: "download",
    Draggable: "draggable",
    Dropzone: "dropzone",
    Dt: "dt",
    Em: "em",
    Embed: "embed",
    Enctype: "enctype",
    Face: "face",
    Fieldset: "fieldset",
    Figcaption: "figcaption",
    Figure: "figure",
    File: "file",
    Filegroup: "filegroup",
    Font: "font",
    Footer: "footer",
    For: "for",
    ForeignObject: "foreignObject",
    Foreignobject: "foreignobject",
    Form: "form",
    Formaction: "formaction",
    Formenctype: "formenctype",
    Formmethod: "formmethod",
    Formnovalidate: "formnovalidate",
    Formtarget: "formtarget",
    Frame: "frame",
    Frameset: "frameset",
    Go: "go",
    H1: "h1",
    H2: "h2",
    H3: "h3",
    H4: "h4",
    H5: "h5",
    H6: "h6",
    HTML: "html",
    HTTPEquiv: "http-equiv",
    Head: "head",
    Header: "header",
    Headers: "headers",
    Headings: ["h1", "h2", "h3", "h4", "h5", "h6"],
    Height: "height",
    Hgroup: "hgroup",
    Hidden: "hidden",
    High: "high",
    Hr: "hr",
    Href: "href",
    Hreflang: "hreflang",
    I: "i",
    ID: "id",
    Icon: "icon",
    Iframe: "iframe",
    Image: "image",
    Img: "img",
    Include: "include",
    Input: "input",
    Inputmode: "inputmode",
    Ins: "ins",
    Integrity: "integrity",
    Is: "is",
    Isindex: "isindex",
    Ismap: "ismap",
    Itemid: "itemid",
    Itemprop: "itemprop",
    Itemref: "itemref",
    Itemscope: "itemscope",
    Itemtype: "itemtype",
    Kbd: "kbd",
    Keygen: "keygen",
    Keytype: "keytype",
    Kind: "kind",
    Label: "label",
    Lang: "lang",
    Legend: "legend",
    Li: "li",
    Link: "link",
    List: "list",
    Listing: "listing",
    Loop: "loop",
    Low: "low",
    Main: "main",
    Malignmark: "malignmark",
    Manifest: "manifest",
    Map: "map",
    Mark: "mark",
    Marquee: "marquee",
    Math: "math",
    Max: "max",
    Maxlength: "maxlength",
    Media: "media",
    Mediagroup: "mediagroup",
    Menu: "menu",
    Menuitem: "menuitem",
    Meta: "meta",
    Metadata: "metadata",
    Meter: "meter",
    Method: "method",
    Mglyph: "mglyph",
    Mi: "mi",
    Min: "min",
    Minlength: "minlength",
    Mn: "mn",
    Mo: "mo",
    Ms: "ms",
    Mtext: "mtext",
    Multiple: "multiple",
    Muted: "muted",
    Name: "name",
    Nav: "nav",
    Nobr: "nobr",
    Noembed: "noembed",
    Noframes: "noframes",
    Nomodule: "nomodule",
    Nonce: "nonce",
    Noscript: "noscript",
    Novalidate: "novalidate",
    Object: "object",
    Ol: "ol",
    Onabort: "onabort",
    Onafterprint: "onafterprint",
    Onautocomplete: "onautocomplete",
    Onautocompleteerror: "onautocompleteerror",
    Onauxclick: "onauxclick",
    Onbeforeprint: "onbeforeprint",
    Onbeforeunload: "onbeforeunload",
    Onblur: "onblur",
    Oncancel: "oncancel",
    Oncanplay: "oncanplay",
    Oncanplaythrough: "oncanplaythrough",
    Onchange: "onchange",
    Onclick: "onclick",
    Onclose: "onclose",
    Oncontextmenu: "oncontextmenu",
    Oncopy: "oncopy",
    Oncuechange: "oncuechange",
    Oncut: "oncut",
    Ondblclick: "ondblclick",
    Ondrag: "ondrag",
    Ondragend: "ondragend",
    Ondragenter: "ondragenter",
    Ondragexit: "ondragexit",
    Ondragleave: "ondragleave",
    Ondragover: "ondragover",
    Ondragstart: "ondragstart",
    Ondrop: "ondrop",
    Ondurationchange: "ondurationchange",
    Onemptied: "onemptied",
    Onended: "onended",
    Onerror: "onerror",
    Onfocus: "onfocus",
    Onhashchange: "onhashchange",
    Oninput: "oninput",
    Oninvalid: "oninvalid",
    Onkeydown: "onkeydown",
    Onkeypress: "onkeypress",
    Onkeyup: "onkeyup",
    Onlanguagechange: "onlanguagechange",
    Onload: "onload",
    Onloadeddata: "onloadeddata",
    Onloadedmetadata: "onloadedmetadata",
    Onloadend: "onloadend",
    Onloadstart: "onloadstart",
    Onmessage: "onmessage",
    Onmessageerror: "onmessageerror",
    Onmousedown: "onmousedown",
    Onmouseenter: "onmouseenter",
    Onmouseleave: "onmouseleave",
    Onmousemove: "onmousemove",
    Onmouseout: "onmouseout",
    Onmouseover: "onmouseover",
    Onmouseup: "onmouseup",
    Onmousewheel: "onmousewheel",
    Onoffline: "onoffline",
    Ononline: "ononline",
    Onpagehide: "onpagehide",
    Onpageshow: "onpageshow",
    Onpaste: "onpaste",
    Onpause: "onpause",
    Onplay: "onplay",
    Onplaying: "onplaying",
    Onpopstate: "onpopstate",
    Onprogress: "onprogress",
    Onratechange: "onratechange",
    Onrejectionhandled: "onrejectionhandled",
    Onreset: "onreset",
    Onresize: "onresize",
    Onscroll: "onscroll",
    Onsecuritypolicyviolation: "onsecuritypolicyviolation",
    Onseeked: "onseeked",
    Onseeking: "onseeking",
    Onselect: "onselect",
    Onshow: "onshow",
    Onsort: "onsort",
    Onstalled: "onstalled",
    Onstorage: "onstorage",
    Onsubmit: "onsubmit",
    Onsuspend: "onsuspend",
    Ontimeupdate: "ontimeupdate",
    Ontoggle: "ontoggle",
    Onunhandledrejection: "onunhandledrejection",
    Onunload: "onunload",
    Onvolumechange: "onvolumechange",
    Onwaiting: "onwaiting",
    Onwheel: "onwheel",
    Open: "open",
    Optgroup: "optgroup",
    Optimum: "optimum",
    Option: "option",
    Output: "output",
    P: "p",
    Page: "page",
    Param: "param",
    Pattern: "pattern",
    Picture: "picture",
    Ping: "ping",
    Placeholder: "placeholder",
    Plaintext: "plaintext",
    Playsinline: "playsinline",
    Poster: "poster",
    Pre: "pre",
    Preload: "preload",
    Progress: "progress",
    Prompt: "prompt",
    Public: "public",
    Q: "q",
    Radiogroup: "radiogroup",
    Rb: "rb",
    Readonly: "readonly",
    Ref: "ref",
    Referrerpolicy: "referrerpolicy",
    Rel: "rel",
    Required: "required",
    Reversed: "reversed",
    Rows: "rows",
    Rowspan: "rowspan",
    Rp: "rp",
    Rt: "rt",
    Rtc: "rtc",
    Ruby: "ruby",
    S: "s",
    Samp: "samp",
    Sandbox: "sandbox",
    Scope: "scope",
    Scoped: "scoped",
    Script: "script",
    Seamless: "seamless",
    Section: "section",
    Select: "select",
    Selected: "selected",
    Shape: "shape",
    Size: "size",
    Sizes: "sizes",
    Slot: "slot",
    Small: "small",
    Sortable: "sortable",
    Sorted: "sorted",
    Source: "source",
    Spacer: "spacer",
    Span: "span",
    Spellcheck: "spellcheck",
    Src: "src",
    Srcdoc: "srcdoc",
    Srclang: "srclang",
    Srcset: "srcset",
    Start: "start",
    Step: "step",
    Strike: "strike",
    Strong: "strong",
    Style: "style",
    Sub: "sub",
    Summary: "summary",
    Sup: "sup",
    Svg: "svg",
    System: "system",
    Tabindex: "tabindex",
    Table: "table",
    Target: "target",
    Tbody: "tbody",
    Td: "td",
    Template: "template",
    Textarea: "textarea",
    Tfoot: "tfoot",
    Th: "th",
    Thead: "thead",
    Time: "time",
    Title: "title",
    Tr: "tr",
    Track: "track",
    Translate: "translate",
    Tt: "tt",
    Type: "type",
    Typemustmatch: "typemustmatch",
    U: "u",
    Ul: "ul",
    Unknown: "unknown",
    Updateviacache: "updateviacache",
    Usemap: "usemap",
    Value: "value",
    Var: "var",
    Video: "video",
    Wbr: "wbr",
    Width: "width",
    Workertype: "workertype",
    Wrap: "wrap",
    Xmp: "xmp",
};

class Link extends Element {
    constructor(l) {
        super(l);
        this.url = l.url;
    }
}
function NewLink(url, attrs) {
    let ats = attrs ? attrs : {};
    if ((ats === null || ats === void 0 ? void 0 : ats.href) === undefined) {
        ats.href = url;
    }
    return new Link({
        atom: atoms.A,
        attributes: ats,
        nodes: [],
        type: gotypes.Link,
        url: url,
    });
}

class OL extends Element {
    constructor(ol) {
        super(ol);
    }
}

class Page extends Element {
    constructor(n) {
        super(n);
    }
}

class Ref extends Element {
    constructor(r) {
        super(r);
    }
}

class Snippet extends Element {
    constructor(s) {
        super(s);
        this.content = s.content;
        this.lang = s.lang;
        this.name = s.name;
        this.start = s.start;
        this.end = s.end;
    }
}

class SourceCode extends Element {
    constructor(sc) {
        super(sc);
        this.lang = sc.lang;
    }
}

class Table extends Element {
    constructor(t) {
        super(t);
    }
}

class Text {
    constructor(t) {
        this.atom = "text";
        this.nodes = [];
        this.type = t.type;
        this.text = t.text;
    }
    toString() {
        return this.text;
    }
    toHtml() {
        return this.text;
    }
}
function NewText(text) {
    return new Text({
        type: gotypes.Text,
        text: text,
    });
}

class UL extends Element {
    constructor(ul) {
        super(ul);
    }
}
function NewUL(attrs) {
    return new UL({
        atom: atoms.Ul,
        type: gotypes.UL,
        nodes: [],
        attributes: attrs,
    });
}

function ParseNodes(nodes = []) {
    let ret = [];
    nodes.forEach((n) => {
        if (n == null) {
            return;
        }
        n.nodes = ParseNodes(n.nodes);
        switch (n.type) {
            case gotypes.Body:
            case gotypes.Element:
            case gotypes.Paragraph:
            case gotypes.TD:
            case gotypes.TH:
            case gotypes.THead:
            case gotypes.TR:
                ret.push(new Element(n));
                break;
            case gotypes.Page:
                ret.push(new Page(n));
                break;
            case gotypes.Text:
                ret.push(new Text(n));
                break;
            case gotypes.Heading:
                ret.push(new Heading(n));
                break;
            case gotypes.InlineCode:
                ret.push(new InlineCode(n));
                break;
            case gotypes.Include:
                ret.push(new Include(n));
                break;
            case gotypes.Link:
                ret.push(new Link(n));
                break;
            case gotypes.Figure:
                ret.push(new Figure(n));
                break;
            case gotypes.Table:
                ret.push(new Table(n));
                break;
            case gotypes.Ref:
                ret.push(new Ref(n));
                break;
            case gotypes.Cmd:
                ret.push(new Cmd(n));
                break;
            case gotypes.CmdResult:
                ret.push(new CmdResult(n));
                break;
            case gotypes.Snippet:
                ret.push(new Snippet(n));
                break;
            case gotypes.FencedCode:
                ret.push(new FencedCode(n));
                break;
            case gotypes.SourceCode:
                ret.push(new SourceCode(n));
                break;
            case gotypes.OL:
                ret.push(new OL(n));
                break;
            case gotypes.UL:
                ret.push(new UL(n));
                break;
            case gotypes.LI:
                ret.push(new LI(n));
                break;
            case gotypes.Image:
                ret.push(new Image(n));
                break;
            case gotypes.Figcaption:
            case "*hype.FigCaption":
                ret.push(new FigCaption(n));
                break;
            default:
                if (Array.isArray(n)) {
                    nodes = ParseNodes(n);
                    ret.push(...nodes);
                    break;
                }
                console.log("unknown node type", n.type, n);
                throw new Error("Unknown node type: " + n.type);
        }
    });
    return ret;
}

class Document extends Element {
    constructor(el) {
        super(el);
        this.id = "";
        this.file = "module.md";
        this.root = el.root;
        this.title = el.title;
        this.parser = el.parser;
        this.file = el.file;
        if (this.file === undefined) {
            this.file = "module.md";
        }
        this.id = el.id ? el.id : uuid.v4();
        this.nodes = ParseNodes(el.nodes);
    }
    toString() {
        var _a;
        let s = "";
        (_a = this.nodes) === null || _a === void 0 ? void 0 : _a.forEach((n) => {
            s += n.toString();
        });
        return s;
    }
    toHtml() {
        var _a;
        let s = "";
        (_a = this.nodes) === null || _a === void 0 ? void 0 : _a.forEach((n) => {
            s += n.toHtml();
        });
        return s;
    }
}

function VisitAtom(atom, n, fn) {
    var _a;
    if (n === undefined) {
        return;
    }
    (_a = n.nodes) === null || _a === void 0 ? void 0 : _a.forEach((e) => {
        VisitAtom(atom, e, fn);
    });
    let atoms = [];
    if (Array.isArray(atom)) {
        atoms = atom;
    }
    else {
        atoms.push(atom);
    }
    atoms.forEach((a) => {
        if (a === n.atom) {
            fn(n);
        }
    });
    return;
    // func ByAtom[T ~string](nodes Nodes, want ...T) []AtomableNode {
    // 	var res []AtomableNode
    // 	for _, n := range nodes {
    // 		an, ok := n.(AtomableNode)
    // 		if !ok {
    // 			res = append(res, ByAtom(n.Children(), want...)...)
    // 			continue
    // 		}
    // 		for _, w := range want {
    // 			if an.Atom().String() == string(w) {
    // 				res = append(res, an)
    // 				break
    // 			}
    // 		}
    // 		res = append(res, ByAtom(n.Children(), want...)...)
    // 	}
    // 	return res
    // }
}

class Toc extends Element {
    constructor() {
        super({
            nodes: [],
            atom: atoms.Ul,
            type: gotypes.UL,
            attributes: {
                class: "hype-toc",
            }
        });
        this.ids = [];
        this.nodes = [];
    }
    perform(doc, gen) {
        VisitAtom(atoms.Headings, doc, (n) => {
            let h = new Heading(n);
            // this.headings.push(h);
            let id = gen ? gen() : newUUID();
            this.ids.push(id);
            let a = NewLink(`#${id}`);
            let li = NewElement(atoms.Li, { class: `hype-toc-lvl-${h.level}` });
            a.nodes = h.nodes;
            li.nodes = [a];
            this.nodes.push(li);
            let nodes = n.nodes;
            let b = NewElement(atoms.A);
            b.attributes = { name: id };
            n.nodes = [b, ...nodes];
        });
    }
}
function newUUID() {
    return `heading-${uuid.v4()}`;
}

exports.Cmd = Cmd;
exports.CmdResult = CmdResult;
exports.Document = Document;
exports.Element = Element;
exports.FencedCode = FencedCode;
exports.FigCaption = FigCaption;
exports.Figure = Figure;
exports.Heading = Heading;
exports.Image = Image;
exports.Include = Include;
exports.InlineCode = InlineCode;
exports.LI = LI;
exports.Link = Link;
exports.NewElement = NewElement;
exports.NewLink = NewLink;
exports.NewText = NewText;
exports.NewUL = NewUL;
exports.OL = OL;
exports.Page = Page;
exports.ParseNodes = ParseNodes;
exports.Ref = Ref;
exports.Snippet = Snippet;
exports.SourceCode = SourceCode;
exports.Table = Table;
exports.Text = Text;
exports.Toc = Toc;
exports.UL = UL;
exports.VisitAtom = VisitAtom;
exports.atoms = atoms;
exports.gotypes = gotypes;
